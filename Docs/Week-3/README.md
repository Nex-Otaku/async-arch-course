# Домашка третьей недели

## 1. Миграция поля "title" в задачах

Делаем из поля "title" два поля - "title" и "jiraId".

1. Внедряем версионирование событий и валидацию по схеме.

2. Помечаем исходное событие как событие с версией 1.

3. Описываем событие с новыми полями как событие с версией 2.

4. Обновляем консюмер - чтобы он мог обрабатывать события версий 1 и 2.

5. Обновляем продюсер - переводим его с событий версии 1 на события версии 2.

6. Если после миграции всё стабильно то удаляем из кода консюмера и продюсера события версии 1.

## 2. Миграция статуса задачи

Task Assigned => Task "Bird in Cage"

Task Completed => Task "Millet in Plate"

1. Меняем значение статуса задачи в БД и коде таск-трекера. Так как само поле статуса будет использоваться только "внутри" таск-трекера, то остальные сервисы на этом шаге править не нужно.

Если же используется в других сервисах, то правим внутри сервисов, аналогично правкам в таск-трекере. 

Эти обновления не меняют логику взаимодействия и не влияют на коммуникацию между сервисами, поэтому мы можем выкатить их в любом порядке.

2. Создаём новые события в консюмерах.

В имени событий используем новое именование, добавляем их в консюмеры и привязываем в обработчике событий те же методы что использовались для "старых" событий.

3. Создаём новые события в продюсерах.

В имени событий используем новое именование, добавляем их в продюсеры и отправляем их вместо старых событий. Старые события из продюсера удаляем.

4. Удаляем старые события из консюмера.

## 3. Стратегия защиты данных биллинга

Если есть какие-то ошибочные события:

1. Отправляем алерт о том что событие не удалось обработать;

2. Возвращаем событие в очередь (в текущей реализации просто не помечаем что оно было обработано)

3. Выполняем задержку (sleep) на 1, 2, 4, 10, 60, 180, 600, 3600 секунд и после каждой задержки ретраим пока события не будут корректно обработаны